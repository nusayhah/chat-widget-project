(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
    typeof define === 'function' && define.amd ? define(factory) :
    (global = typeof globalThis !== 'undefined' ? globalThis : global || self, global.ChatWidget = factory());
})(this, (function () { 'use strict';

    /******************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
    /* global Reflect, Promise, SuppressedError, Symbol, Iterator */


    function __awaiter(thisArg, _arguments, P, generator) {
        function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
        return new (P || (P = Promise))(function (resolve, reject) {
            function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
            function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
            function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
            step((generator = generator.apply(thisArg, _arguments || [])).next());
        });
    }

    typeof SuppressedError === "function" ? SuppressedError : function (error, suppressed, message) {
        var e = new Error(message);
        return e.name = "SuppressedError", e.error = error, e.suppressed = suppressed, e;
    };

    class ChatWidget {
        constructor(config) {
            this.container = null;
            this.chatWindow = null;
            this.overlay = null;
            this.isOpen = false;
            this.isMinimized = true;
            this.websocket = null;
            this.messages = [];
            this.config = Object.assign({ apiUrl: config.apiUrl || `http://${window.location.hostname}:5000/api`, businessName: 'Support Team', widgetTitle: 'Chat with us', welcomeMessage: 'Hello! How can we help you today?', primaryColor: '#007bff', secondaryColor: '#6c757d', position: 'bottom-right', enablePrechatForm: false, prechatFields: [] }, config);
            this.sessionId = this.generateSessionId();
            this.isMobile = window.innerWidth <= 768;
            this.init();
        }
        generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }
        init() {
            return __awaiter(this, void 0, void 0, function* () {
                try {
                    // Fetch configuration from backend
                    yield this.fetchWidgetConfig();
                    // Create widget elements
                    this.createWidget();
                    // Set up WebSocket connection
                    this.setupWebSocket();
                    // Add welcome message
                    this.addMessage({
                        id: 'welcome',
                        text: this.config.welcomeMessage || 'Hello! How can we help you today?',
                        sender: 'agent',
                        timestamp: new Date()
                    });
                }
                catch (error) {
                    console.error('Failed to initialize chat widget:', error);
                }
            });
        }
        fetchWidgetConfig() {
            return __awaiter(this, void 0, void 0, function* () {
                try {
                    const response = yield fetch(`${this.config.apiUrl}/widgets/${this.config.siteKey}/config`);
                    if (response.ok) {
                        const serverConfig = yield response.json();
                        this.config = Object.assign(Object.assign({}, this.config), serverConfig);
                    }
                }
                catch (error) {
                    console.warn('Failed to fetch widget config, using defaults:', error);
                }
            });
        }
        createWidget() {
            // Create main container
            this.container = document.createElement('div');
            this.container.id = 'chat-widget-container';
            this.container.innerHTML = this.getWidgetHTML();
            // Add styles
            this.addStyles();
            // Append to body
            document.body.appendChild(this.container);
            // Get references
            this.chatWindow = this.container.querySelector('.chat-window');
            if (this.isMobile) {
                this.overlay = this.container.querySelector('.chat-overlay');
            }
            // Add event listeners
            this.addEventListeners();
        }
        getWidgetHTML() {
            const positionClass = `chat-widget-${this.config.position}`;
            if (this.isMobile) {
                // MOBILE: Sidebar design with overlay
                return `
        <div class="chat-widget ${positionClass}">
          <!-- Chat Button -->
          <div class="chat-button" id="chat-toggle">
            <svg class="chat-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="currentColor"/>
            </svg>
          </div>

          <!-- Overlay (mobile only) -->
          <div class="chat-overlay"></div>

          <!-- Chat Window (mobile sidebar) -->
          <div class="chat-window mobile-chat">
            <div class="chat-header">
              <div class="chat-header-info">
                <h3>${this.config.widgetTitle}</h3>
                <p>${this.config.businessName}</p>
              </div>
              <button class="close-btn" id="close-chat">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
            
            <div class="chat-messages" id="chat-messages">
              <!-- Messages will be added here -->
            </div>
            
            <div class="chat-input-container">
              <div class="chat-input-wrapper">
                <input 
                  type="text" 
                  id="chat-input" 
                  placeholder="Type your message..." 
                  maxlength="500"
                />
                <button id="send-message" class="send-btn">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
            }
            else {
                // DESKTOP: Old compact design
                return `
        <div class="chat-widget ${positionClass}">
          <!-- Chat Button -->
          <div class="chat-button" id="chat-toggle">
            <svg class="chat-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="currentColor"/>
            </svg>
            <svg class="close-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>

          <!-- Chat Window (desktop compact) -->
          <div class="chat-window desktop-chat">
            <div class="chat-header">
              <div class="chat-header-info">
                <h3>${this.config.widgetTitle}</h3>
                <p>${this.config.businessName}</p>
              </div>
              <button class="minimize-btn" id="minimize-chat">âˆ’</button>
            </div>
            
            <div class="chat-messages" id="chat-messages">
              <!-- Messages will be added here -->
            </div>
            
            <div class="chat-input-container">
              <div class="chat-input-wrapper">
                <input 
                  type="text" 
                  id="chat-input" 
                  placeholder="Type your message..." 
                  maxlength="500"
                />
                <button id="send-message" class="send-btn">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
            }
        }
        addStyles() {
            const style = document.createElement('style');
            style.textContent = `
      /* Chat Widget Styles */
      #chat-widget-container {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        z-index: 999999;
      }

      .chat-widget {
        position: fixed;
        z-index: 999999;
      }

      .chat-widget-bottom-right {
        bottom: 20px;
        right: 20px;
      }

      .chat-widget-bottom-left {
        bottom: 20px;
        left: 20px;
      }

      .chat-widget-top-right {
        top: 20px;
        right: 20px;
      }

      .chat-widget-top-left {
        top: 20px;
        left: 20px;
      }

      /* Chat Button */
      .chat-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: ${this.config.primaryColor};
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        position: relative;
      }

      .chat-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      }

      .chat-button svg {
        width: 24px;
        height: 24px;
        transition: all 0.3s ease;
      }

      .chat-button .close-icon {
        position: absolute;
        opacity: 0;
        transform: rotate(90deg);
      }

      .chat-button.active .chat-icon {
        opacity: 0;
        transform: rotate(-90deg);
      }

      .chat-button.active .close-icon {
        opacity: 1;
        transform: rotate(0deg);
      }

      /* ==================== */
      /* MOBILE STYLES - SIDEBAR DESIGN */
      /* ==================== */
      
      /* Overlay - MOBILE ONLY */
      .chat-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 999998;
      }

      .chat-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      /* Chat Window - MOBILE SIDEBAR */
      .mobile-chat {
        position: fixed;
        top: 0;
        right: -100%;
        width: 100%;
        height: 100%;
        background: white;
        display: flex;
        flex-direction: column;
        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 999999;
        overflow: hidden;
      }

      .mobile-chat.open {
        right: 0;
      }

      .chat-widget-bottom-left .mobile-chat,
      .chat-widget-top-left .mobile-chat {
        right: auto;
        left: -100%;
      }

      .chat-widget-bottom-left .mobile-chat.open,
      .chat-widget-top-left .mobile-chat.open {
        left: 0;
        right: auto;
      }

      /* ==================== */
      /* DESKTOP STYLES - OLD COMPACT DESIGN */
      /* ==================== */
      
      /* Chat Window - DESKTOP COMPACT */
      .desktop-chat {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 350px;
        height: 500px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        display: flex;
        flex-direction: column;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px) scale(0.95);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
      }

      .chat-widget-bottom-left .desktop-chat,
      .chat-widget-top-left .desktop-chat {
        right: auto;
        left: 0;
      }

      .chat-widget-top-right .desktop-chat,
      .chat-widget-top-left .desktop-chat {
        bottom: auto;
        top: 80px;
      }

      .desktop-chat.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
      }

      .desktop-chat.minimized {
        height: 60px;
      }

      /* ==================== */
      /* SHARED STYLES */
      /* ==================== */

      .chat-header {
        background: ${this.config.primaryColor};
        color: white;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
      }

      .chat-header-info h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }

      .chat-header-info p {
        margin: 0;
        font-size: 12px;
        opacity: 0.8;
      }

      .close-btn, .minimize-btn {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
        -webkit-tap-highlight-color: transparent;
      }

      .close-btn:hover, .minimize-btn:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .close-btn svg {
        width: 20px;
        height: 20px;
      }

      .minimize-btn {
        font-size: 20px;
      }

      .chat-messages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .desktop-chat.minimized .chat-messages {
        display: none;
      }

      .message {
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.4;
        word-wrap: break-word;
      }

      .message.user {
        background: ${this.config.primaryColor};
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 6px;
      }

      .message.agent {
        background: #f1f3f5;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 6px;
      }

      .message-time {
        font-size: 11px;
        opacity: 0.6;
        margin-top: 4px;
        text-align: center;
      }

      .chat-input-container {
        padding: 16px;
        border-top: 1px solid #e9ecef;
        flex-shrink: 0;
      }

      .desktop-chat.minimized .chat-input-container {
        display: none;
      }

      .chat-input-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      #chat-input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s;
      }

      #chat-input:focus {
        border-color: ${this.config.primaryColor};
      }

      .send-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: ${this.config.primaryColor};
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .send-btn:hover {
        transform: scale(1.05);
      }

      .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .send-btn svg {
        width: 16px;
        height: 16px;
      }

      /* Mobile-specific adjustments */
      @media (max-width: 768px) {
        .chat-button {
          width: 70px;
          height: 70px;
        }

        .chat-header {
          padding: 20px 16px;
        }

        .chat-header-info h3 {
          font-size: 18px;
        }

        .chat-header-info p {
          font-size: 14px;
        }

        .chat-messages {
          padding: 16px 12px;
        }

        .message {
          max-width: 85%;
          padding: 12px 16px;
          font-size: 16px;
        }

        .chat-input-container {
          padding: 16px 12px;
        }

        #chat-input {
          font-size: 16px;
          padding: 14px 16px;
          min-height: 48px;
        }

        .send-btn {
          width: 44px;
          height: 44px;
          min-width: 44px;
          min-height: 44px;
        }

        .send-btn svg {
          width: 20px;
          height: 20px;
        }
      }

      /* Typing indicator */
      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 10px 14px;
        background: #f1f3f5;
        border-radius: 18px;
        border-bottom-left-radius: 6px;
        align-self: flex-start;
        max-width: 80px;
      }

      .typing-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #999;
        animation: typing 1.4s infinite ease-in-out;
      }

      .typing-dot:nth-child(1) { animation-delay: -0.32s; }
      .typing-dot:nth-child(2) { animation-delay: -0.16s; }

      @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
      }
    `;
            document.head.appendChild(style);
        }
        addEventListeners() {
            var _a, _b, _c, _d, _e, _f;
            // Toggle chat window
            const toggleBtn = (_a = this.container) === null || _a === void 0 ? void 0 : _a.querySelector('#chat-toggle');
            if (this.isMobile) {
                // MOBILE: Open chat
                toggleBtn === null || toggleBtn === void 0 ? void 0 : toggleBtn.addEventListener('click', () => this.openChat());
                // Close chat (mobile)
                const closeBtn = (_b = this.container) === null || _b === void 0 ? void 0 : _b.querySelector('#close-chat');
                closeBtn === null || closeBtn === void 0 ? void 0 : closeBtn.addEventListener('click', () => this.closeChat());
                // Close on overlay click (mobile)
                (_c = this.overlay) === null || _c === void 0 ? void 0 : _c.addEventListener('click', () => this.closeChat());
            }
            else {
                // DESKTOP: Toggle chat
                toggleBtn === null || toggleBtn === void 0 ? void 0 : toggleBtn.addEventListener('click', () => this.toggleChat());
                // Minimize chat (desktop)
                const minimizeBtn = (_d = this.container) === null || _d === void 0 ? void 0 : _d.querySelector('#minimize-chat');
                minimizeBtn === null || minimizeBtn === void 0 ? void 0 : minimizeBtn.addEventListener('click', () => this.minimizeChat());
            }
            // Send message (both)
            const sendBtn = (_e = this.container) === null || _e === void 0 ? void 0 : _e.querySelector('#send-message');
            const input = (_f = this.container) === null || _f === void 0 ? void 0 : _f.querySelector('#chat-input');
            sendBtn === null || sendBtn === void 0 ? void 0 : sendBtn.addEventListener('click', () => this.sendMessage());
            input === null || input === void 0 ? void 0 : input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.sendMessage();
                }
            });
        }
        openChat() {
            var _a, _b;
            // MOBILE: Open sidebar
            this.isOpen = true;
            (_a = this.chatWindow) === null || _a === void 0 ? void 0 : _a.classList.add('open');
            (_b = this.overlay) === null || _b === void 0 ? void 0 : _b.classList.add('active');
            document.body.style.overflow = 'hidden';
            // Focus input when opened
            setTimeout(() => {
                var _a;
                const input = (_a = this.container) === null || _a === void 0 ? void 0 : _a.querySelector('#chat-input');
                input === null || input === void 0 ? void 0 : input.focus();
            }, 300);
        }
        closeChat() {
            var _a, _b;
            // MOBILE: Close sidebar
            this.isOpen = false;
            (_a = this.chatWindow) === null || _a === void 0 ? void 0 : _a.classList.remove('open');
            (_b = this.overlay) === null || _b === void 0 ? void 0 : _b.classList.remove('active');
            document.body.style.overflow = '';
        }
        toggleChat() {
            var _a, _b;
            // DESKTOP: Toggle compact chat
            const button = (_a = this.container) === null || _a === void 0 ? void 0 : _a.querySelector('.chat-button');
            const window = (_b = this.container) === null || _b === void 0 ? void 0 : _b.querySelector('.chat-window');
            if (this.isOpen) {
                this.isOpen = false;
                button === null || button === void 0 ? void 0 : button.classList.remove('active');
                window === null || window === void 0 ? void 0 : window.classList.remove('open');
            }
            else {
                this.isOpen = true;
                this.isMinimized = false;
                button === null || button === void 0 ? void 0 : button.classList.add('active');
                window === null || window === void 0 ? void 0 : window.classList.add('open');
                window === null || window === void 0 ? void 0 : window.classList.remove('minimized');
                // Focus input when opened
                setTimeout(() => {
                    var _a;
                    const input = (_a = this.container) === null || _a === void 0 ? void 0 : _a.querySelector('#chat-input');
                    input === null || input === void 0 ? void 0 : input.focus();
                }, 300);
            }
        }
        minimizeChat() {
            var _a, _b;
            // DESKTOP: Minimize compact chat
            const window = (_a = this.container) === null || _a === void 0 ? void 0 : _a.querySelector('.chat-window');
            const minimizeBtn = (_b = this.container) === null || _b === void 0 ? void 0 : _b.querySelector('#minimize-chat');
            if (this.isMinimized) {
                this.isMinimized = false;
                window === null || window === void 0 ? void 0 : window.classList.remove('minimized');
                if (minimizeBtn)
                    minimizeBtn.textContent = 'âˆ’';
            }
            else {
                this.isMinimized = true;
                window === null || window === void 0 ? void 0 : window.classList.add('minimized');
                if (minimizeBtn)
                    minimizeBtn.textContent = '+';
            }
        }
        sendMessage() {
            var _a;
            const input = (_a = this.container) === null || _a === void 0 ? void 0 : _a.querySelector('#chat-input');
            const message = input === null || input === void 0 ? void 0 : input.value.trim();
            if (!message)
                return;
            // Add user message
            this.addMessage({
                id: this.generateMessageId(),
                text: message,
                sender: 'user',
                timestamp: new Date()
            });
            // Clear input
            if (input)
                input.value = '';
            // Send via WebSocket
            this.sendWebSocketMessage(message);
            // Show typing indicator
            this.showTypingIndicator();
        }
        generateMessageId() {
            return 'msg_' + Math.random().toString(36).substr(2, 9);
        }
        addMessage(message) {
            var _a;
            this.messages.push(message);
            const messagesContainer = (_a = this.container) === null || _a === void 0 ? void 0 : _a.querySelector('#chat-messages');
            if (!messagesContainer)
                return;
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.sender}`;
            messageElement.innerHTML = `
      <div>${this.escapeHtml(message.text)}</div>
      <div class="message-time">${this.formatTime(message.timestamp)}</div>
    `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        showTypingIndicator() {
            var _a;
            const messagesContainer = (_a = this.container) === null || _a === void 0 ? void 0 : _a.querySelector('#chat-messages');
            if (!messagesContainer)
                return;
            const typingElement = document.createElement('div');
            typingElement.className = 'typing-indicator';
            typingElement.id = 'typing-indicator';
            typingElement.innerHTML = `
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    `;
            messagesContainer.appendChild(typingElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        hideTypingIndicator() {
            var _a;
            const typingElement = (_a = this.container) === null || _a === void 0 ? void 0 : _a.querySelector('#typing-indicator');
            typingElement === null || typingElement === void 0 ? void 0 : typingElement.remove();
        }
        setupWebSocket() {
            try {
                const apiUrl = this.config.apiUrl || (typeof window !== 'undefined' ? `http://${window.location.hostname}:5000/api` : 'http://localhost:5000/api');
                const wsBaseUrl = apiUrl
                    .replace('https://', 'wss://')
                    .replace('http://', 'ws://')
                    .replace('/api', '');
                const wsUrl = `${wsBaseUrl}/ws/${this.sessionId}`;
                this.websocket = new WebSocket(wsUrl);
                this.websocket.onopen = () => {
                    console.log('WebSocket connected');
                };
                this.websocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    }
                    catch (error) {
                        console.error('Failed to parse WebSocket message:', error);
                    }
                };
                this.websocket.onclose = () => {
                    console.log('WebSocket disconnected');
                    setTimeout(() => this.setupWebSocket(), 3000);
                };
                this.websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            }
            catch (error) {
                console.error('Failed to setup WebSocket:', error);
            }
        }
        sendWebSocketMessage(message, type = 'message') {
            var _a;
            if (((_a = this.websocket) === null || _a === void 0 ? void 0 : _a.readyState) === WebSocket.OPEN) {
                this.websocket.send(JSON.stringify({
                    type: type,
                    sessionId: this.sessionId,
                    siteKey: this.config.siteKey,
                    message: message,
                    timestamp: new Date().toISOString()
                }));
            }
        }
        handleWebSocketMessage(data) {
            this.hideTypingIndicator();
            switch (data.type) {
                case 'message':
                    this.addMessage({
                        id: data.id || this.generateMessageId(),
                        text: data.message,
                        sender: 'agent',
                        timestamp: new Date(data.timestamp || Date.now())
                    });
                    break;
                case 'typing':
                    if (data.isTyping) {
                        this.showTypingIndicator();
                    }
                    else {
                        this.hideTypingIndicator();
                    }
                    break;
                case 'escalation_started':
                    this.addMessage({
                        id: 'escalation-' + Date.now(),
                        text: data.message || 'ðŸš¨ Connecting you with a human agent...',
                        sender: 'agent',
                        timestamp: new Date()
                    });
                    break;
                case 'queue_update':
                    this.addMessage({
                        id: 'queue-' + Date.now(),
                        text: `â³ You are position ${data.position} in the queue. Estimated wait: ${data.estimatedWait} minutes`,
                        sender: 'agent',
                        timestamp: new Date()
                    });
                    break;
                case 'agent_joined':
                    this.addMessage({
                        id: 'agent-joined-' + Date.now(),
                        text: data.message || 'ðŸ‘‹ A human agent has joined the chat!',
                        sender: 'agent',
                        timestamp: new Date()
                    });
                    break;
                default:
                    console.log('Unknown message type:', data.type);
            }
        }
        // Public API methods
        open() {
            if (!this.isOpen) {
                if (this.isMobile) {
                    this.openChat();
                }
                else {
                    this.toggleChat();
                }
            }
        }
        close() {
            if (this.isOpen) {
                if (this.isMobile) {
                    this.closeChat();
                }
                else {
                    this.toggleChat();
                }
            }
        }
        destroy() {
            var _a, _b;
            (_a = this.websocket) === null || _a === void 0 ? void 0 : _a.close();
            (_b = this.container) === null || _b === void 0 ? void 0 : _b.remove();
        }
    }
    // Export for use
    window.ChatWidget = ChatWidget;
    window.initChatWidget = (config) => new ChatWidget(config);
    // Auto-initialize if config is provided via data attributes
    document.addEventListener('DOMContentLoaded', () => {
        const scripts = document.querySelectorAll('script[data-site-key]');
        scripts.forEach((script) => {
            const siteKey = script.getAttribute('data-site-key');
            if (siteKey) {
                new ChatWidget({ siteKey });
            }
        });
    });

    return ChatWidget;

}));
